name: ðŸŒ Cross-Platform Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-cross-platform:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: "ðŸ§ Ubuntu"
          - os: macos-latest  
            name: "ðŸŽ macOS"
          - os: windows-latest
            name: "ðŸªŸ Windows (Git Bash)"

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Git Bash (Windows)
        if: runner.os == 'Windows'
        run: |
          # Git Bash comes pre-installed on GitHub Windows runners
          echo "Using Git Bash on Windows"

      - name: â„¹ï¸  System Information
        shell: bash
        run: |
          echo "ðŸ–¥ï¸  OS: $(uname -s)"
          echo "ðŸ—ï¸  Architecture: $(uname -m)"
          echo "ðŸ“ Shell: $0"
          echo "ðŸ”§ Available tools:"
          command -v curl && echo "  âœ… curl" || echo "  âŒ curl"
          command -v wget && echo "  âœ… wget" || echo "  âŒ wget"
          command -v tar && echo "  âœ… tar" || echo "  âŒ tar"
          command -v jq && echo "  âœ… jq" || echo "  âŒ jq"

      - name: ðŸ§ª Test Help Command
        shell: bash
        run: |
          chmod +x install.sh
          ./install.sh --help

      - name: ðŸŒ Test Platform Detection
        shell: bash
        run: |
          echo "Testing platform detection..."
          echo "Debug: uname -s = $(uname -s)"
          echo "Debug: uname -m = $(uname -m)"
          echo "Running platform detection test..."
          if ! DRY_RUN=true VERBOSE=true ./install.sh 2>&1 | grep "Detecting platform"; then
            echo "Platform detection failed. Full output:"
            DRY_RUN=true VERBOSE=true ./install.sh 2>&1 || true
            exit 1
          fi

      - name: ðŸ“¦ Test OSS Dry Run
        shell: bash
        run: |
          echo "Testing OSS dry run..."
          DRY_RUN=true ./install.sh latest oss

      - name: ðŸ¢ Test Secure Dry Run  
        shell: bash
        run: |
          echo "Testing Secure dry run..."
          DRY_RUN=true ./install.sh 5.0.0 secure

      - name: âš ï¸  Test Error Handling
        shell: bash
        run: |
          echo "Testing error handling..."
          OUTPUT=$(./install.sh invalid.version 2>&1 || true)
          echo "Captured output:"
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "Unknown argument"; then
            echo "âœ… Error handling works"
          else
            echo "âŒ Error handling failed - pattern not found"
            exit 1
          fi

      - name: ðŸš€ Test Actual Installation (OSS only)
        shell: bash
        run: |
          echo "Testing actual OSS installation..."
          VERBOSE=true ./install.sh latest oss
          
          # Debug: Show what files were actually created
          echo "Debug: Checking installation files..."
          echo "HOME directory: $HOME"
          if [ -d "$HOME/.local" ]; then
            echo "Contents of $HOME/.local:"
            ls -la "$HOME/.local"
            if [ -d "$HOME/.local/bin" ]; then
              echo "Contents of $HOME/.local/bin:"
              ls -la "$HOME/.local/bin"
            fi
            if [ -d "$HOME/.local/lib" ]; then
              echo "Contents of $HOME/.local/lib:"
              ls -la "$HOME/.local/lib"
            fi
          fi
          
          # Verify installation - check direct paths since PATH may not persist on some platforms
          LIQUIBASE_FOUND=false
          
          # First try PATH (works on most platforms)
          if command -v liquibase >/dev/null 2>&1; then
            echo "âœ… Liquibase found in PATH"
            liquibase --version
            LIQUIBASE_FOUND=true
          else
            echo "â„¹ï¸  Liquibase not found in PATH (expected on some platforms)"
            
            # Try direct installation paths
            for location in "/usr/local/bin/liquibase" "$HOME/.local/bin/liquibase"; do
              if [ -x "$location" ]; then
                echo "âœ… Liquibase found at: $location"
                "$location" --version
                LIQUIBASE_FOUND=true
                break
              fi
            done
          fi
          
          if [ "$LIQUIBASE_FOUND" = "false" ]; then
            echo "âŒ Liquibase not found in any expected location"
            exit 1
          else
            echo "âœ… Liquibase installation verified successfully"
          fi

  test-summary:
    name: ðŸ“Š Cross-Platform Summary
    runs-on: ubuntu-latest
    needs: test-cross-platform
    if: always()
    
    steps:
      - name: ðŸ“ˆ Generate Summary
        run: |
          echo "## ðŸŒ Cross-Platform Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-cross-platform.result }}" == "success" ]; then
            echo "âœ… **All platforms**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… ðŸ§ **Ubuntu**: Native bash environment" >> $GITHUB_STEP_SUMMARY  
            echo "âœ… ðŸŽ **macOS**: Native zsh/bash environment" >> $GITHUB_STEP_SUMMARY
            echo "âœ… ðŸªŸ **Windows**: Git Bash environment" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some platforms failed**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Coverage**: Platform detection, OSS & Secure editions, Error handling, Actual installation" >> $GITHUB_STEP_SUMMARY